#!/bin/bash
# NAS Docker í™˜ê²½ ì´ˆê¸° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
# NASì—ì„œ ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
# ì‚¬ìš©ë²•: ssh -p 22022 crossman@192.168.0.5 í›„ ì‹¤í–‰

set -euo pipefail

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# ===========================================
# 1. ì‹œìŠ¤í…œ í™•ì¸
# ===========================================
check_system() {
    log_info "ì‹œìŠ¤í…œ í™˜ê²½ í™•ì¸ ì¤‘..."
    
    # Docker ì„¤ì¹˜ í™•ì¸
    if ! command -v docker &> /dev/null; then
        log_error "Dockerê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. DSM Package Centerì—ì„œ Dockerë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”."
        exit 1
    fi
    
    # Docker ì„œë¹„ìŠ¤ í™•ì¸
    if ! docker info &> /dev/null; then
        log_error "Docker ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        exit 1
    fi
    
    log_success "Docker ì„¤ì¹˜ ë° ì‹¤í–‰ í™•ì¸ ì™„ë£Œ"
    
    # Docker Compose í™•ì¸ ë° ì„¤ì¹˜
    if ! command -v docker-compose &> /dev/null; then
        log_warning "Docker Composeê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
        install_docker_compose
    else
        log_success "Docker Compose ì„¤ì¹˜ í™•ì¸ ì™„ë£Œ"
    fi
}

# ===========================================
# 2. Docker Compose ì„¤ì¹˜
# ===========================================
install_docker_compose() {
    log_info "Docker Compose ì„¤ì¹˜ ì¤‘..."
    
    # ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    
    # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
    sudo chmod +x /usr/local/bin/docker-compose
    
    # ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± (ì„ íƒì‚¬í•­)
    sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
    
    # ì„¤ì¹˜ í™•ì¸
    if docker-compose --version &> /dev/null; then
        log_success "Docker Compose ì„¤ì¹˜ ì™„ë£Œ"
    else
        log_error "Docker Compose ì„¤ì¹˜ ì‹¤íŒ¨"
        exit 1
    fi
}

# ===========================================
# 3. ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
# ===========================================
setup_directories() {
    log_info "ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± ì¤‘..."
    
    # ê¸°ë³¸ ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p /volume1/dev/{docker,data,config,logs}
    mkdir -p /volume1/dev/docker/{services,scripts}
    mkdir -p /volume1/dev/data/{postgres,n8n,gitea,code-server,uptime-kuma,portainer,mcp-server}
    mkdir -p /volume1/dev/config/{nginx,ssl,backup}
    mkdir -p /volume1/dev/logs/{nginx,services}
    
    # ê¶Œí•œ ì„¤ì •
    chown -R $(whoami):users /volume1/dev
    chmod -R 755 /volume1/dev
    
    log_success "ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± ì™„ë£Œ"
    
    # ë””ë ‰í† ë¦¬ êµ¬ì¡° ì¶œë ¥
    log_info "ìƒì„±ëœ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
    tree /volume1/dev || ls -la /volume1/dev
}

# ===========================================
# 4. Docker ë„¤íŠ¸ì›Œí¬ ìƒì„±
# ===========================================
setup_docker_network() {
    log_info "Docker ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì¤‘..."
    
    # ê¸°ì¡´ ë„¤íŠ¸ì›Œí¬ í™•ì¸ ë° ìƒì„±
    if ! docker network ls | grep -q "nas-services-network"; then
        docker network create \
            --driver bridge \
            --subnet=172.20.0.0/16 \
            --gateway=172.20.0.1 \
            nas-services-network
        log_success "Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± ì™„ë£Œ: nas-services-network"
    else
        log_info "Docker ë„¤íŠ¸ì›Œí¬ê°€ ì´ë¯¸ ì¡´ìž¬í•©ë‹ˆë‹¤: nas-services-network"
    fi
    
    # ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì¶œë ¥
    docker network inspect nas-services-network
}

# ===========================================
# 5. í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„±
# ===========================================
create_env_file() {
    log_info "í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
    
    cat > /volume1/dev/docker/.env << 'EOF'
# NAS Docker Services Environment Configuration
# Generated by setup script

# ===========================================
# ê¸°ë³¸ í™˜ê²½ ì„¤ì •
# ===========================================
COMPOSE_PROJECT_NAME=nas-services
DOCKER_NETWORK=nas-services-network

# NAS ì •ë³´
NAS_HOST=192.168.0.5
BASE_DOMAIN=crossman.synology.me

# ===========================================
# ë°ì´í„° ê²½ë¡œ
# ===========================================
DATA_ROOT=/volume1/dev/data
CONFIG_ROOT=/volume1/dev/config
LOGS_ROOT=/volume1/dev/logs

# ===========================================
# ì„œë¹„ìŠ¤ë³„ í¬íŠ¸ ë§¤í•‘
# ===========================================
N8N_PORT=31001
MCP_PORT=31002
UPTIME_PORT=31003
CODE_PORT=8484
GITEA_HTTP_PORT=3000
GITEA_SSH_PORT=2222
PORTAINER_PORT=9000

# ===========================================
# ì¸ì¦ ì •ë³´ (ë³€ê²½ í•„ìš”!)
# ===========================================
DB_PASSWORD=nas_secure_password_2025
N8N_PASSWORD=n8n_admin_password_2025
VSCODE_PASSWORD=vscode_admin_password_2025
GITEA_SECRET_KEY=gitea_secret_key_2025

# ===========================================
# SSL & ë„ë©”ì¸ ì„¤ì •
# ===========================================
SSL_EMAIL=admin@crossman.synology.me
ENABLE_SSL=true

# ===========================================
# íƒ€ìž„ì¡´ ì„¤ì •
# ===========================================
TZ=Asia/Seoul
EOF
    
    log_success "í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ: /volume1/dev/docker/.env"
    log_warning "ë³´ì•ˆì„ ìœ„í•´ .env íŒŒì¼ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”!"
}

# ===========================================
# 6. í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
# ===========================================
create_health_check_script() {
    log_info "í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..."
    
    cat > /volume1/dev/docker/scripts/health-check.sh << 'EOF'
#!/bin/bash
# Docker ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸

source /volume1/dev/docker/.env

echo "ðŸ¥ NAS Docker ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬"
echo "ì‹œê°„: $(date)"
echo "==============================="

# ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
echo "ðŸ“‹ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
docker-compose -f /volume1/dev/docker/docker-compose.yml ps

echo ""
echo "ðŸŒ ì„œë¹„ìŠ¤ ì ‘ì† í…ŒìŠ¤íŠ¸:"

# ì„œë¹„ìŠ¤ë³„ ì ‘ì† í…ŒìŠ¤íŠ¸
declare -A services=(
    ["PostgreSQL"]="localhost:5432"
    ["n8n"]="localhost:$N8N_PORT"
    ["Gitea"]="localhost:$GITEA_HTTP_PORT"
    ["Code-Server"]="localhost:$CODE_PORT"
    ["Uptime-Kuma"]="localhost:$UPTIME_PORT"
    ["Portainer"]="localhost:$PORTAINER_PORT"
    ["MCP-Server"]="localhost:$MCP_PORT"
)

for service in "${!services[@]}"; do
    endpoint="${services[$service]}"
    host="${endpoint%%:*}"
    port="${endpoint##*:}"
    
    if nc -z "$host" "$port" 2>/dev/null; then
        echo "âœ… $service ($endpoint): ì •ìƒ"
    else
        echo "âŒ $service ($endpoint): ë¹„ì •ìƒ"
    fi
done

echo ""
echo "ðŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
df -h /volume1/dev

echo ""
echo "ðŸ”§ Docker ì‹œìŠ¤í…œ ì •ë³´:"
docker system df
EOF
    
    chmod +x /volume1/dev/docker/scripts/health-check.sh
    log_success "í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ"
}

# ===========================================
# 7. ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
# ===========================================
create_backup_script() {
    log_info "ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..."
    
    cat > /volume1/dev/docker/scripts/backup-services.sh << 'EOF'
#!/bin/bash
# Docker ì„œë¹„ìŠ¤ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

source /volume1/dev/docker/.env

BACKUP_DIR="/volume1/backup/docker-services/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "ðŸ“¦ Docker ì„œë¹„ìŠ¤ ë°±ì—… ì‹œìž‘"
echo "ë°±ì—… ê²½ë¡œ: $BACKUP_DIR"

# 1. Docker Compose ì„¤ì • ë°±ì—…
echo "1. Docker Compose ì„¤ì • ë°±ì—… ì¤‘..."
cp -r /volume1/dev/docker "$BACKUP_DIR/"

# 2. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
echo "2. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì¤‘..."
if docker ps | grep -q postgres; then
    docker exec $(docker ps -q -f name=postgres) pg_dumpall -U nasuser > "$BACKUP_DIR/database_backup.sql"
    echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì™„ë£Œ"
else
    echo "âš ï¸ PostgreSQL ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ"
fi

# 3. ì„œë¹„ìŠ¤ ë°ì´í„° ë°±ì—…
echo "3. ì„œë¹„ìŠ¤ ë°ì´í„° ë°±ì—… ì¤‘..."
tar -czf "$BACKUP_DIR/service_data.tar.gz" -C /volume1/dev data

# 4. ì„¤ì • íŒŒì¼ ë°±ì—…
echo "4. ì„¤ì • íŒŒì¼ ë°±ì—… ì¤‘..."
tar -czf "$BACKUP_DIR/config.tar.gz" -C /volume1/dev config

# 5. ë°±ì—… ì •ë³´ íŒŒì¼ ìƒì„±
cat > "$BACKUP_DIR/backup_info.txt" << BACKUP_INFO
ë°±ì—… ìƒì„± ì‹œê°„: $(date)
ë°±ì—… ì‹¤í–‰ìž: $(whoami)
ì‹œìŠ¤í…œ ì •ë³´: $(uname -a)
Docker ë²„ì „: $(docker --version)
Docker Compose ë²„ì „: $(docker-compose --version)

í¬í•¨ëœ ì„œë¹„ìŠ¤:
$(docker-compose -f /volume1/dev/docker/docker-compose.yml ps --services)

ì»¨í…Œì´ë„ˆ ìƒíƒœ:
$(docker-compose -f /volume1/dev/docker/docker-compose.yml ps)
BACKUP_INFO

echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
ls -la "$BACKUP_DIR"
EOF
    
    chmod +x /volume1/dev/docker/scripts/backup-services.sh
    log_success "ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ"
}

# ===========================================
# 8. ì„œë¹„ìŠ¤ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
# ===========================================
create_service_management_scripts() {
    log_info "ì„œë¹„ìŠ¤ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..."
    
    # ì„œë¹„ìŠ¤ ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸
    cat > /volume1/dev/docker/scripts/start-services.sh << 'EOF'
#!/bin/bash
cd /volume1/dev/docker
echo "ðŸš€ Docker ì„œë¹„ìŠ¤ ì‹œìž‘ ì¤‘..."
docker-compose up -d
echo "âœ… ì„œë¹„ìŠ¤ ì‹œìž‘ ì™„ë£Œ"
docker-compose ps
EOF
    
    # ì„œë¹„ìŠ¤ ì¤‘ì§€ ìŠ¤í¬ë¦½íŠ¸
    cat > /volume1/dev/docker/scripts/stop-services.sh << 'EOF'
#!/bin/bash
cd /volume1/dev/docker
echo "ðŸ›‘ Docker ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
docker-compose down
echo "âœ… ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ"
EOF
    
    # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸
    cat > /volume1/dev/docker/scripts/restart-services.sh << 'EOF'
#!/bin/bash
cd /volume1/dev/docker
echo "ðŸ”„ Docker ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ì¤‘..."
docker-compose restart
echo "âœ… ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ì™„ë£Œ"
docker-compose ps
EOF
    
    # ë¡œê·¸ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
    cat > /volume1/dev/docker/scripts/view-logs.sh << 'EOF'
#!/bin/bash
cd /volume1/dev/docker

if [ -z "$1" ]; then
    echo "ì‚¬ìš©ë²•: $0 [ì„œë¹„ìŠ¤ëª…]"
    echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤:"
    docker-compose ps --services
    exit 1
fi

echo "ðŸ“‹ $1 ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸ (ìµœê·¼ 100ì¤„)"
docker-compose logs --tail=100 -f "$1"
EOF
    
    # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
    chmod +x /volume1/dev/docker/scripts/*.sh
    
    log_success "ì„œë¹„ìŠ¤ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ"
}

# ===========================================
# ë©”ì¸ í•¨ìˆ˜
# ===========================================
main() {
    log_info "=========================================="
    log_info "NAS Docker í™˜ê²½ ì´ˆê¸° ì„¤ì • ì‹œìž‘"
    log_info "=========================================="
    
    check_system
    setup_directories
    setup_docker_network
    create_env_file
    create_health_check_script
    create_backup_script
    create_service_management_scripts
    
    log_success "=========================================="
    log_success "NAS Docker í™˜ê²½ ì„¤ì • ì™„ë£Œ!"
    log_success "=========================================="
    
    log_info "ë‹¤ìŒ ë‹¨ê³„:"
    log_info "1. .env íŒŒì¼ì˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½: vi /volume1/dev/docker/.env"
    log_info "2. Docker Compose íŒŒì¼ ì—…ë¡œë“œ: /volume1/dev/docker/docker-compose.yml"
    log_info "3. ì„œë¹„ìŠ¤ ì‹œìž‘: cd /volume1/dev/docker && docker-compose up -d"
    log_info "4. ìƒíƒœ í™•ì¸: /volume1/dev/docker/scripts/health-check.sh"
    
    log_info ""
    log_info "ìƒì„±ëœ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸:"
    log_info "- í—¬ìŠ¤ì²´í¬: /volume1/dev/docker/scripts/health-check.sh"
    log_info "- ë°±ì—…: /volume1/dev/docker/scripts/backup-services.sh"
    log_info "- ì„œë¹„ìŠ¤ ì‹œìž‘: /volume1/dev/docker/scripts/start-services.sh"
    log_info "- ì„œë¹„ìŠ¤ ì¤‘ì§€: /volume1/dev/docker/scripts/stop-services.sh"
    log_info "- ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘: /volume1/dev/docker/scripts/restart-services.sh"
    log_info "- ë¡œê·¸ í™•ì¸: /volume1/dev/docker/scripts/view-logs.sh [ì„œë¹„ìŠ¤ëª…]"
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
